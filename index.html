<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="theme-color" content="#0a2342">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Dreams Bus">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">

    <title>Dreams School Bus</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '#0a2342',
                            secondary: '#044735',
                            accent: '#f3f4f6'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 5px rgba(0,0,0,0.05)',
                        'floating': '0 -4px 10px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        /* تحسين شكل الكروت */
        .student-card { transition: transform 0.1s, background-color 0.2s; touch-action: manipulation; }
        .student-card:active { transform: scale(0.98); }
        .present-active { background-color: #dcfce7; border: 1px solid #22c55e; }
        .absent-active { background-color: #ffffff; border: 1px solid #e5e7eb; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0a2342;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 pb-24 select-none"> <header class="bg-brand-primary text-white p-4 sticky top-0 z-40 shadow-md">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="Dreams Logo" class="w-10 h-10 object-contain bg-white rounded-full p-0.5">
                <div>
                    <h1 class="text-lg font-bold leading-tight">Dreams School</h1>
                    <p class="text-xs text-gray-300 font-mono" id="currentDate">--/--/----</p>
                </div>
            </div>
            
            <button onclick="toggleModal()" class="bg-brand-secondary/90 w-9 h-9 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                <i class="fas fa-plus text-sm"></i>
            </button>
        </div>
        
        <div class="relative">
            <input type="text" id="searchInput" placeholder="بحث باسم الطالب..." 
                class="w-full py-2.5 px-4 pr-10 rounded-xl text-gray-800 bg-gray-100 border-none focus:ring-2 focus:ring-brand-secondary transition shadow-inner text-sm">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
    </header>

    <main id="app" class="p-3 max-w-lg mx-auto min-h-screen">
        
        <div id="loading" class="flex flex-col items-center justify-center py-12">
            <div class="loader mb-3"></div>
            <p class="text-sm text-gray-500">جاري تحميل القائمة...</p>
        </div>

        <div id="studentList" class="space-y-3 hidden"></div>

        <div id="noResults" class="hidden flex flex-col items-center justify-center py-10 text-gray-400">
            <i class="fas fa-child text-4xl mb-2 opacity-50"></i>
            <p class="text-sm">لا يوجد طالب بهذا الاسم</p>
        </div>
    </main>

    <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 p-3 shadow-floating z-50 flex gap-3 max-w-lg left-0 right-0 mx-auto pb-6">
        <button onclick="toggleSelectAll()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold text-sm active:bg-gray-200 transition flex items-center justify-center gap-2">
            <i class="fas fa-check-double text-gray-500"></i> الكل
        </button>
        <button onclick="submitAttendance()" class="flex-[2] bg-brand-secondary text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-800 active:scale-95 transition flex items-center justify-center gap-2">
            <i class="fas fa-save"></i> حفظ الحضور
        </button>
    </div>

    <div id="addStudentModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-sm sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="bg-brand-primary p-4 text-white flex justify-between items-center">
                <h3 class="font-bold">طالب جديد <i class="fas fa-user-plus mr-2 text-xs opacity-70"></i></h3>
                <button onclick="toggleModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">اسم الطالب</label>
                    <input type="text" id="newInfoName" class="w-full mt-1 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-brand-primary border outline-none transition" placeholder="الاسم ثلاثي">
                </div>
                
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">المرحلة</label>
                        <select id="newInfoGrade" class="w-full mt-1 border-gray-300 rounded-lg p-2.5 bg-gray-50 border outline-none h-11">
    <option>KG 1</option>
    <option>KG 2</option>
    
    <option>Grade 1</option>
    <option>Grade 2</option>
    <option>Grade 3</option>
    <option>Grade 4</option>
    <option>Grade 5</option>
    <option>Grade 6</option>
    
    <option>Grade 7</option> <option>Grade 8</option> <option>Grade 9</option> 
</select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">الباص</label>
                        <input type="text" id="newInfoBus" class="w-full mt-1 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-brand-primary border outline-none h-11" placeholder="مثال: A">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">هاتف الولي</label>
                    <input type="tel" id="newInfoPhone" class="w-full mt-1 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-brand-primary border outline-none" placeholder="01xxxxxxxxx">
                </div>

                <button onclick="saveNewStudent()" class="w-full bg-brand-secondary text-white font-bold py-3.5 rounded-xl hover:bg-green-800 active:scale-95 transition shadow-lg mt-2">
                    حفظ وإضافة للقائمة
                </button>
            </div>
        </div>
    </div>

    <script>
        // ***************** الرابط الجديد *****************
        const API_URL = "https://script.google.com/macros/s/AKfycbwAcZlqAAI1qcSsWoYpmKT-Mjy_EGlNEFt4TF-oCmvftcf_aJvwLnczh5IyGxl-DMoTIw/exec";
        // *************************************************

        let studentsData = [];
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').textContent = today;

        // 1. Fetch Data
        window.onload = async function() {
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                if(result.status === 'success') {
                    studentsData = result.data.map(s => ({...s, status: 'Absent'}));
                    renderStudents(studentsData);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('studentList').classList.remove('hidden');
                }
            } catch (error) {
                alert("تعذر الاتصال بالسيرفر. تأكد من الإنترنت.");
                console.error(error);
            }
        };

        // 2. Render Cards
        function renderStudents(list) {
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            if(list.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                return;
            } else {
                document.getElementById('noResults').classList.add('hidden');
            }

            list.forEach(student => {
                const isPresent = student.status === 'Present';
                // تصميم الكارت
                const card = `
                    <div onclick="toggleStatus('${student.id}')" 
                         class="student-card cursor-pointer p-4 rounded-xl flex items-center justify-between shadow-card mb-2 ${isPresent ? 'present-active' : 'absent-active'}">
                        
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isPresent ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-300'}">
                                <i class="fas ${isPresent ? 'fa-check' : 'fa-user'}"></i>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-gray-800 text-base">${student.name}</h3>
                                <div class="text-xs text-gray-500 flex items-center gap-2">
                                    <span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">${student.grade}</span>
                                    <span class="flex items-center"><i class="fas fa-bus-alt text-[10px] ml-1"></i> ${student.busRoute}</span>
                                </div>
                            </div>
                        </div>

                        <a href="tel:${student.parentPhone}" onclick="event.stopPropagation()" 
                           class="w-9 h-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 active:scale-90 transition border border-blue-100">
                            <i class="fas fa-phone text-sm"></i>
                        </a>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // 3. Toggle Status (Click on Card)
        window.toggleStatus = function(id) {
            const student = studentsData.find(s => s.id === id);
            if(student) {
                student.status = (student.status === 'Present') ? 'Absent' : 'Present';
                // إعادة رسم ذكية (تحديث الكلاسات فقط أفضل، لكن لإعادة الرسم السريع مع البحث):
                const searchTerm = document.getElementById('searchInput').value;
                const filtered = studentsData.filter(s => s.name.includes(searchTerm));
                renderStudents(filtered);
            }
        }

        // 4. Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value;
            const filtered = studentsData.filter(s => s.name.includes(term));
            renderStudents(filtered);
        });

        // 5. Select All
        window.toggleSelectAll = function() {
            const allPresent = studentsData.every(s => s.status === 'Present');
            const newStatus = allPresent ? 'Absent' : 'Present';
            studentsData.forEach(s => s.status = newStatus);
            // تحديث العرض حسب البحث الحالي
            const searchTerm = document.getElementById('searchInput').value;
            renderStudents(studentsData.filter(s => s.name.includes(searchTerm)));
        }

        // 6. Submit Attendance
        window.submitAttendance = async function() {
            const btn = document.querySelector('button[onclick="submitAttendance()"]');
            const icon = btn.querySelector('i');
            
            // Loading State
            icon.className = "fas fa-spinner fa-spin";
            btn.disabled = true;
            btn.classList.add('opacity-80');

            // لاحظ: Action = attendance
            const payload = {
                action: "attendance",
                records: studentsData.map(s => ({
                    id: s.id, status: s.status, date: today
                }))
            };

            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain" }
                });
                alert("✅ تم حفظ الحضور!");
            } catch (error) {
                console.error(error);
                alert("✅ تم الإرسال!");
            } finally {
                icon.className = "fas fa-save";
                btn.disabled = false;
                btn.classList.remove('opacity-80');
            }
        }

        // 7. Modal Functions
        window.toggleModal = function() {
            const modal = document.getElementById('addStudentModal');
            modal.classList.toggle('hidden');
        }

        // 8. Add Student
        window.saveNewStudent = async function() {
            const btn = document.querySelector('#addStudentModal button');
            const originalText = btn.innerHTML;
            
            const name = document.getElementById('newInfoName').value;
            const grade = document.getElementById('newInfoGrade').value;
            const bus = document.getElementById('newInfoBus').value;
            const phone = document.getElementById('newInfoPhone').value;

            if(!name) { alert("اكتب الاسم!"); return; }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري...';
            btn.disabled = true;

            // لاحظ: Action = add_student
            const payload = {
                action: "add_student",
                data: { name, grade, bus, phone }
            };

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain" }
                });
                const result = await response.json();
                
                if(result.status === 'success') {
                    // إضافة الطالب محلياً
                    studentsData.push({ ...result.newStudent, status: 'Absent' });
                    renderStudents(studentsData);
                    toggleModal();
                    alert("تمت الإضافة!");
                    // تفريغ الحقول
                    document.getElementById('newInfoName').value = '';
                    document.getElementById('newInfoPhone').value = '';
                }
            } catch (error) {
                alert("تم إرسال الطلب، تحقق من الشيت.");
                toggleModal();
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
